#!/usr/bin/env python3
import os
import subprocess
import sys
import platform

version = platform.python_version_tuple()
major_version = int(version[0])
minor_version = int(version[1])
if major_version < 3 or minor_version < 6:
    sys.stderr.write('Require Python 3.6 or higher to run nearup\n')
    exit(2)

nearup_dir = os.path.expanduser('~/.nearup')
main_script = os.path.expanduser('~/.nearup/main.py')
if os.path.exists(main_script):
    p = subprocess.Popen('cd ' + nearup_dir + ' && git pull',
                         stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True)
    _stdout, stderr = p.communicate()
    if p.returncode != 0:
        sys.stderr.write('Warning: Failed to update nearup. Error:\n')
        sys.stderr.write(stderr + '\n')
    args = ['python3', main_script] + sys.argv[1:]
    subprocess.run(args)
else:
    p = subprocess.Popen(
        ['git', 'clone', 'https://github.com/nearprotocol/nearup', os.path.expanduser('~/.nearup')], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    _stdout, stderr = p.communicate()
    if p.returncode != 0:
        sys.stderr.write('Failed to obtain nearup. Error:\n')
        sys.stderr.write(stderr + '\n')
        subprocess.check_output(['rm', '-rf', os.path.expanduser('~/.nearup')])
        exit(1)

    print('Nearup is installed to ~/.nearup!\n')
    in_path = False
    if os.path.exists(os.path.expanduser('~/.profile')):
        with open(os.path.expanduser('~/.profile'), 'r') as f:
            if 'source $HOME/.nearup/env' in f.read():
                in_path = True
    if not in_path:
        with open(os.path.expanduser('~/.profile'), 'a') as f:
            f.write('\n\nsource $HOME/.nearup/env\n\n')
        with open(os.path.expanduser('~/.zprofile'), 'a') as f:
            f.write('\n\nsource $HOME/.nearup/env\n\n')
        if os.path.exists(os.path.expanduser('~/.config/fish')):
            with open(os.path.expanduser('~/.config/fish/config.fish'), 'a') as f:
                f.write('\n\nsource $HOME/.nearup/env\n\n')
        print('''To get started you need Nearup's directory ($HOME/.nearup) in your PATH
environment variable. Next time you log in this will be done automatically.

To configure your current shell run `source $HOME/.nearup/env`''')
